# Workflow 名称（GitHub 页面显示用）
name: MSVC 自动构建 Debug 版本

# 触发器：指定哪些事件会触发流水线
on:
  push:
    branches: [ main ]  # 推送代码到 main 分支时触发
  pull_request:
    branches: [ main ]  # 提交 PR 到 main 分支时触发
  workflow_dispatch:  # 允许手动触发（GitHub 页面点击「Run workflow」）

# 定义 Job（这里只定义 1 个 Job：在 Windows 上构建）
jobs:
  build-windows-msvc:
    name: Windows + MSVC 构建
    runs-on: windows-latest  # 使用 GitHub 提供的最新 Windows 虚拟机器（内置 VS Build Tools）
    permissions:
      contents: write  # 允许上传构建产物到 GitHub（后续步骤用）

    # Job 中的步骤（按顺序执行）
    steps:
      # 步骤 1：拉取仓库代码（GitHub 提供的官方 Action，自动克隆代码到虚拟机器）
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      # 步骤 2：配置 VS Build Tools 环境（激活 MSVC 编译器、CMake）
      - name: 配置 MSVC 环境
        uses: ilammy/msvc-dev-cmd@v1  # 第三方 Action，自动加载 MSVC 环境变量
        with:
          arch: x64  # 指定架构为 x64（与你的项目配置一致）

      # 步骤 3：安装 SDL3 及依赖（关键！你的项目依赖 SDL3，需在虚拟机器中安装）
      - name: 安装 SDL3 及组件（SDL3_image/SDL3_mixer/SDL3_ttf）
        shell: powershell  # 使用 PowerShell 执行命令
        run: |
          # 1. 下载 vcpkg（C++ 包管理器，用于安装 SDL3 依赖）
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat  # 初始化 vcpkg
          
          # 2. 安装 SDL3 及组件（x64-windows 版本，Debug 模式）
          .\vcpkg install sdl3:x64-windows sdl3-image:x64-windows sdl3-mixer:x64-windows sdl3-ttf:x64-windows glm:x64-windows
          
          # 3. 配置 CMake 前缀路径（让 CMake 找到 vcpkg 安装的依赖）
          echo "CMAKE_PREFIX_PATH=$env:GITHUB_WORKSPACE/vcpkg/installed/x64-windows/share" >> $env:GITHUB_ENV

      # 步骤 4：CMake 配置（生成 VS 工程文件）
      - name: CMake 配置
        working-directory: ${{ github.workspace }}  # 工作目录：仓库根目录
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake"

      # 步骤 5：编译构建（Debug 版本）
      - name: 编译构建
        working-directory: ${{ github.workspace }}/build  # 工作目录：build 文件夹
        run: |
          cmake --build . --config Debug -j 6  # -j 6 多线程编译

      # 步骤 6：上传构建产物（.exe 和 .pdb，方便下载测试）
      - name: 上传 Debug 产物
        uses: actions/upload-artifact@v4  # 官方 Action，上传文件到 GitHub
        with:
          name: GhostEscape-Windows-Debug  # 上传包名称（下载时显示）
          path: |
            ${{ github.workspace }}/bin/Debug/GhostEscape-Windows.exe  # 你的可执行文件
            ${{ github.workspace }}/bin/Debug/GhostEscape-Windows.pdb  # 调试符号文件
          retention-days: 7  # 产物保留 7 天（可按需调整）